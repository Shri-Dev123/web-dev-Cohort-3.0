<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <title>Todo App with Auth</title>
  <style>
    #user-info,
    #logout-btn,
    #todo,
    #show-todos {
      display: none;
    }
  </style>
</head>

<body>
  <div id="signup-div">
    <h3>Signup</h3>
    <input id="signup-username" placeholder="Username" type="text" />
    <input id="signup-password" placeholder="Password" type="password" />
    <button onclick="signUp()">Submit</button>
  </div>

  <div id="signin-div">
    <h3>Signin</h3>
    <input id="signin-username" placeholder="Username" type="text" />
    <input id="signin-password" placeholder="Password" type="password" />
    <button onclick="signIn()">Submit</button>
  </div>

  <div id="user-info">
    <h3>User Info</h3>
    <span id="name"></span>
  </div>

  <button id="logout-btn" onclick="logOut()">Log out</button>

  <div id="todo">
    <input id="todo-text" type="text" placeholder="New todo" />
    <button onclick="createTodo()">Create</button>
  </div>

  <div id="show-todos"></div>

  <script>
    const API = "http://localhost:4546";

    const elements = {
      signupDiv: document.getElementById("signup-div"),
      signinDiv: document.getElementById("signin-div"),
      userInfoDiv: document.getElementById("user-info"),
      logoutBtn: document.getElementById("logout-btn"),
      todoCreate: document.getElementById("todo"),
      todoText: document.getElementById("todo-text"),
      showTodos: document.getElementById("show-todos"),
    };

    let todos = [];

    const updateUI = () => {
      const token = localStorage.getItem("token");
      const show = (el, display = "block") => el.style.display = display;
      const hide = (el) => el.style.display = "none";

      if (token) {
        hide(elements.signupDiv);
        hide(elements.signinDiv);
        show(elements.userInfoDiv);
        show(elements.logoutBtn);
        show(elements.todoCreate);
        show(elements.showTodos);
      } else {
        show(elements.signupDiv);
        show(elements.signinDiv);
        hide(elements.userInfoDiv);
        hide(elements.logoutBtn);
        hide(elements.todoCreate);
        hide(elements.showTodos);
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      updateUI();
      const token = localStorage.getItem("token");
      if (token) getInfo();
    });

    const signUp = async () => {
      const userName = document.getElementById("signup-username").value;
      const password = document.getElementById("signup-password").value;

      try {
        await axios.post(`${API}/signup`, {
          userName,
          password
        });
        alert("Signed up successfully. Please sign in.");
      } catch {
        alert("Signup failed.");
      }
    };

    const signIn = async () => {
      const userName = document.getElementById("signin-username").value;
      const password = document.getElementById("signin-password").value;

      try {
        const {
          data
        } = await axios.post(`${API}/signin`, {
          userName,
          password
        });
        localStorage.setItem("token", data.token);
        alert("Signed in successfully");
        updateUI();
        getInfo();
      } catch {
        alert("Signin failed.");
      }
    };

    const getInfo = async () => {
      try {
        const {
          data
        } = await axios.get(`${API}/me`, {
          headers: {
            token: localStorage.getItem("token")
          },
        });
        document.getElementById("name").innerText = `Welcome, ${data.userName}`;
        renderTodos();
      } catch {
        alert("Failed to fetch user info.");
      }
    };

    const logOut = () => {
      localStorage.removeItem("token");
      updateUI();
    };

    const createTodo = async () => {
      const text = elements.todoText.value.trim();
      if (!text) return;

      try {
        await axios.post(`${API}/createTodo`, {
          id: Date.now(),
          text,
        }, {
          headers: {
            token: localStorage.getItem("token")
          }
        });

        elements.todoText.value = '';
        renderTodos();
      } catch {
        alert("Failed to create todo.");
      }
    };

    const renderTodos = async () => {
      try {
        const {
          data
        } = await axios.get(`${API}/getTodos`, {
          headers: {
            token: localStorage.getItem("token")
          }
        });

        todos = data.todos;
        elements.showTodos.innerHTML = '';

        todos.forEach(todo => {
          const div = document.createElement("div");
          div.innerHTML = `
            <span>${todo.text}</span>
            <button onclick="editTodo(${todo.id})">Edit</button>
            <button onclick="deleteTodo(${todo.id})">Delete</button>
          `;
          elements.showTodos.appendChild(div);
        });
      } catch {
        alert("Failed to load todos.");
      }
    };

    const editTodo = async (id) => {
      const todo = todos.find(t => t.id === id);
      const newText = prompt("Edit your todo:", todo.text);
      if (!newText) return;

      try {
        await axios.patch(`${API}/todos/${id}`, {
          text: newText.trim()
        }, {
          headers: {
            token: localStorage.getItem("token")
          }
        });
        renderTodos();
      } catch {
        alert("Failed to update todo.");
      }
    };

    const deleteTodo = async (id) => {
      try {
        await axios.delete(`${API}/todos/${id}`, {
          headers: {
            token: localStorage.getItem("token")
          }
        });
        renderTodos();
      } catch {
        alert("Failed to delete todo.");
      }
    };
  </script>
</body>

</html>